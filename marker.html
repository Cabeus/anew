<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="X-UA-Compatible" content="ie=edge">
		<style type="text/css">
			body,
			html,
			#allmap {
				width: 100%;
				height: 100%;
				overflow: hidden;
				margin: 0;
				font-family: "微软雅黑";
			}
			
			ul>li {
				width: 100px;
				height: 50px;
				background: pink;
				text-align: center;
				line-height: 50px;
				cursor: pointer;
			}
		</style>
		<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=FRGH8U5owxghRjZdVMzllFp4aDQbw8sm"></script>
		<script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
		<title>给覆盖物注册事件</title>
	</head>

	<body>
		<div id="allmap"></div>
		<div style="position:absolute;top:0px;left:0px;">
			<ul>
				<li id="1001">id1001</li>
				<li id="1002">id1002</li>
				<li id="1003">id1003</li>
				<li id="1004">id1004</li>
				<li id="1005">id1005</li>
			</ul>
			<div>
				<p>烟感报警器</p>
				<p>名字名字</p>
			</div>
		</div>
		
		<script type="text/javascript">
			// 百度地图API功能
			var map = new BMap.Map("allmap");
			var point = new BMap.Point(116.404, 39.915);
			map.centerAndZoom(point, 15);
			map.enableScrollWheelZoom(true);

			//			var marker = new BMap.Marker(new BMap.Point(116.404, 39.915)); // 创建点

			//			marker.addEventListener("click", function() {
			//				var p = this.getPosition(); //获取marker的位置
			//				alert("marker的位置是" + p.lng + "," + p.lat);
			//			});
			//			map.addOverlay(marker); //增加点

			$('ul li').click(function() {
				var id = $(this).attr("id");
				//				console.log(id);
				openWindow(id)
			})

			var arr = [{
				'lng': 116.404,
				'lat': 39.910,
				'data': {
					'id': '1001'
				}
			}, {
				'lng': 116.404,
				'lat': 39.911,
				'data': {
					'id': '1002'
				}
			}, {
				'lng': 116.404,
				'lat': 39.912,
				'data': {
					'id': '1003'
				}
			}, {
				'lng': 116.404,
				'lat': 39.913,
				'data': {
					'id': '1004'
				}
			}, {
				'lng': 116.404,
				'lat': 39.914,
				'data': {
					'id': '1005'
				}
			}]

			var arr1 = [{
					"id": "sensor001",
					'lng': "116.404",
					'lat': "39.910",
					"tag": "sensor",
					"name": "XX商店烟感报警器1",
					"status": "normal"
				},
				{
					"id": "sensor002",
					'lng': "116.404",
					'lat': "39.914",
					"tag": "sensor",
					"name": "XX商店烟感报警器2",
					"status": "bug"
				},
				{
					"id": "sensor003",
					'lng': "116.404",
					'lat': "39.912",
					"tag": "sensor",
					"name": "XX商店烟感报警器3",
					"status": "alert"
				}
			]

			for(let i in arr1) {
				var item = arr1[i];
				var element = {
					point: {
						poi: {
							lat: item.lat,
							lng: item.lng
						},
						icon: "http://developing.zxwave.com/besafe/manager/static/img/video.png",
						data: {
							id: item.id,
							tag: item.tag,
							name: item.name,
							status: item.status
						}
					}
				};
				sensorInfo(element.point);
				//				addOverlay({
				//					poi:{lng: 87.310418, lat: 43.865402},
				//					icon:"http://developing.zxwave.com/besafe/manager/static/img/video.png"
				//				}, function() {
				//					playVideo(item.point.data.videoUrl, item.point.data.desc)
				//				})
			}

			//传感器 画点 弹框
			function sensorInfo(point) {
				//画点
				var pt = new BMap.Point(point.poi.lng, point.poi.lat);
				//画图标
				var myIcon = new BMap.Icon(point.icon, new BMap.Size(40, 40), {
					imageSize: new BMap.Size(32, 41)
				});
				//创建标注
				var marker = new BMap.Marker(pt, {
					icon: myIcon
				}); //创建标注

				marker.data = point.data; //附带信息

				map.addOverlay(marker);
				
				
								
				var opts = {
					width : 250,     // 信息窗口宽度
					height: 80,     // 信息窗口高度
					title : "烟感报警器"  // 信息窗口标题
				   };
				var sContent = '<div>'+
								'	<span>名字名字</span><br/>'+
									'<span>更新时间</span>'+
								'</div>';

				var infoWindow = new BMap.InfoWindow(sContent,opts); //创建信息窗口对象

//				infoWindow.data = point.data;

				infoWindow.addEventListener('open', function() { //open
					console.log(this.data)
				}, false)

				marker.addEventListener("click", function() {
					this.openInfoWindow(infoWindow);
				});

			}
			
			

			function addMarkerInfo(point) {
				var myIcon = new BMap.Icon("http://developing.zxwave.com/besafe/manager/static/img/video.png", new BMap.Size(40, 40), {
					imageSize: new BMap.Size(32, 41)
				});
				var pt = new BMap.Point(point.lng, point.lat);
				var marker = new BMap.Marker(pt, {
					icon: myIcon
				}); // 创建点
				marker.data = point.data; //附带信息

				map.addOverlay(marker);

				marker.addEventListener("click", function() {
					this.openInfoWindow(addInfoWindow(point));
				});

				var circle = new BMap.Circle(pt, 500, {
					strokeColor: 'blue',
					strokeWeight: 3,
					strokeStyle: 'dashed',
					fillOpacity: 0.3
				});
				circle.data = point.data;
				circle.dataType = 1;
				map.addOverlay(circle);

			}

			function addInfoWindow(point) {

				var sContent = '<div class="con">' + point.data.id + '</div>';
				var infoWindow = new BMap.InfoWindow(sContent); // 创建信息窗口对象
				infoWindow.disableCloseOnClick(); // 点击地图关闭信息弹窗
				// 设置聊天窗口size
				infoWindow.setWidth(300);
				infoWindow.setHeight(500);
				infoWindow.data = point.data;

				infoWindow.addEventListener('open', function() { // open
					//					console.log(this)
				}, false);
				return infoWindow
			}

			function openWindow(id) {
				for(let i in arr) {
					if(arr[i].data.id == id) {
						var point = arr[i];
						for(let i in map.getOverlays()) {

							//							console.log(map.getOverlays()[i])
							if(typeof map.getOverlays()[i].data == "undefined") {
								console.log("undefined")
							} else {
								//console.log(map.getOverlays()[i])
								//								console.log(map.getOverlays()[i].dataType)
								if(map.getOverlays()[i].dataType != "1") {
									if(map.getOverlays()[i].data.id == id) {
										map.getOverlays()[i].openInfoWindow(addInfoWindow(point));
									}
								} else {

								}

								//								if(map.getOverlays()[i].data.id == id) {
								//									map.getOverlays()[i].openInfoWindow(addInfoWindow(point));
								//								}
							}
						}
					}
				}
			}
		</script>

	</body>

</html>